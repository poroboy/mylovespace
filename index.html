<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Love Space</title>

  <!-- PWA / Theme -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#FF7FA5">
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon-180.png" sizes="180x180">
  <link rel="stylesheet" href="/theme.css">

  <style>
    /* ‡πÇ‡∏Ñ‡∏£‡∏á UI ‡πÄ‡∏ö‡∏≤ ‡πÜ */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; }
    header { position: sticky; top: 0; background: var(--bg); backdrop-filter: blur(6px); z-index: 20; }
    .container{ max-width: 900px; margin: 0 auto; padding: 16px; }
    .brand{ display:flex; align-items:center; gap:10px; padding:12px 16px; }
    .brand h1{ margin:0; font-size: 20px; }
    nav.tabs{
      position: sticky; bottom:0; background:var(--bg); border-top:1px solid #eee;
      display:grid; grid-template-columns: repeat(5, 1fr); gap:0; z-index:30;
    }
    nav.tabs button{
      appearance:none; border:0; background:none; padding:12px 6px; font-weight:600; color:#555;
    }
    nav.tabs button.active{ color: var(--primary); }
    section.view{ display:none; padding: 8px 16px 80px; }
    section.view.active{ display:block; }

    /* Gate */
    #gate{ min-height: 100dvh; display:flex; align-items:center; justify-content:center; }
    #gate .card{ padding:24px; max-width: 360px; text-align:center; }
    #gate h2{ margin: 0 0 4px; }
    #gate .hint{ color:#777; font-size:13px; margin:0 0 16px; }
    .input, .select, textarea{
      width:100%; padding:12px 14px; border:1px solid #eee; border-radius:14px; outline:none;
      background:#fff;
    }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ flex:1; }
    .mt8{ margin-top:8px;} .mt12{ margin-top:12px;} .mt16{ margin-top:16px;} .mt24{ margin-top:24px;}
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--accent); margin-right:6px; margin-bottom:6px; font-size:12px; }
    .gallery{ display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
    .gallery img{ width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px; }
    .list{ display:flex; flex-direction:column; gap:10px;}
    .item{ padding:12px; border-radius:16px; background:#fff; box-shadow: var(--shadow); }
    .item h4{ margin:0 0 6px; }
    .muted{ color:#888; font-size:12px;}
    .btn{ display:inline-block; padding:10px 14px; border-radius:12px; background:var(--primary); color:#fff; border:0; cursor:pointer; }
    .btn.ghost{ background:#fff; color:var(--primary); border:2px solid var(--primary); }
    .right{ float:right; }
  </style>

  <script>
    // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô SW (‡∏Å‡∏£‡∏ì‡∏µ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(console.error);
    }
  </script>
</head>
<body>
  <!-- Gate -->
  <section id="gate">
    <div class="card">
      <h2>My Love üíñ</h2>
      <p class="hint">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</p>
      <input id="gate-input" class="input" type="password" placeholder="‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" autocomplete="off" />
      <button id="gate-enter" class="btn mt12" style="width:100%">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</button>
      <p class="muted mt8">Session ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ 12 ‡∏ä‡∏°. | ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
    </div>
  </section>

  <!-- App -->
  <header>
    <div class="brand container">
      <img src="/icon-192.png" alt="" width="24" height="24" style="border-radius:8px">
      <h1>My Love Space</h1>
      <button id="btn-backup" class="btn ghost right">Backup</button>
    </div>
  </header>

  <main class="container">
    <!-- HOME -->
    <section id="home" class="view active">
      <h3>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á üíï</h3>
      <div class="item">
        <h4>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h4>
        <div class="muted" id="stats">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
      </div>
      <div class="item mt12">
        <h4>‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</h4>
        <div id="next-event" class="muted">‚Äî</div>
      </div>
    </section>

    <!-- MOMENTS -->
    <section id="moments" class="view">
      <h3>Moments</h3>
      <div class="item">
        <div class="row">
          <input id="moment-text" class="input" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÜ" />
        </div>
        <div class="row mt8">
          <input id="moment-date" class="input" type="date" />
          <select id="moment-tag" class="select">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏Å</option>
            <option>date</option>
            <option>birthday</option>
            <option>anniversary</option>
          </select>
        </div>
        <div class="row mt8">
          <input id="moment-newtag" class="input" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô trip, gift)" />
          <button id="btn-add-moment" class="btn">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      </div>
      <div id="moment-list" class="list mt12"></div>
    </section>

    <!-- GALLERY -->
    <section id="gallery" class="view">
      <h3>Gallery</h3>
      <div class="item">
        <input id="file" type="file" accept="image/*" />
        <button id="btn-upload" class="btn mt8">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‚â§ 5MB)</button>
        <div class="muted mt8">‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Ñ‡∏ô‡∏≠‡∏±‡∏õ‡πÑ‡∏î‡πâ (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô)</div>
      </div>
      <div id="grid" class="gallery mt12"></div>
    </section>

    <!-- CALENDAR -->
    <section id="calendar" class="view">
      <h3>Calendar</h3>
      <div class="item">
        <div class="row">
          <input id="ev-title" class="input" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå" />
        </div>
        <div class="row mt8">
          <input id="ev-date" class="input" type="date" />
          <input id="ev-time" class="input" type="time" />
        </div>
        <div class="row mt8">
          <button id="btn-add-ev" class="btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå</button>
          <button id="btn-export-ics" class="btn ghost">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î .ics</button>
        </div>
      </div>
      <div id="ev-list" class="list mt12"></div>
    </section>

    <!-- NOTES -->
    <section id="notes" class="view">
      <h3>Love Notes</h3>
      <div class="item">
        <textarea id="note" rows="5" class="input" placeholder="‡∏ù‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô ‡πÜ ‡∏ñ‡∏∂‡∏á‡∏Å‡∏±‡∏ô"></textarea>
        <button id="btn-save-note" class="btn mt12">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
      <div id="note-preview" class="item mt12"></div>
    </section>
  </main>

  <nav class="tabs">
    <button data-tab="home" class="active">Home</button>
    <button data-tab="moments">Moments</button>
    <button data-tab="gallery">Gallery</button>
    <button data-tab="calendar">Calendar</button>
    <button data-tab="notes">Notes</button>
  </nav>
  <!-- Firebase (CDN) -->
  <script type="module">
    // 1) ‡∏ß‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Project settings ‚Üí Web App (</>) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    const firebaseConfig = {
    apiKey: "AIzaSyA0uh3epDJVeJxVVL-Khj4y7-hZJ6RNuZk",
    authDomain: "mylovespace-demo.firebaseapp.com",
    projectId: "mylovespace-demo",
    storageBucket: "mylovespace-demo.appspot.com",
    messagingSenderId: "916222730232",
    appId: "1:916222730232:web:bd5fb50199a4a383e3400d",
    measurementId: "G-9ZD0T5EPLJ"
    };

    // 2) ‡πÇ‡∏´‡∏•‡∏î SDK ‡πÅ‡∏•‡∏∞ init
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, serverTimestamp, collection, addDoc, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // 3) ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö Anonymous ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
    signInAnonymously(auth).catch(console.error);

    // 4) ‡πÇ‡∏¢‡∏ô‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå app.js ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
    window._fb = {
      app, auth, db, storage,
      fs: { serverTimestamp, collection, addDoc, doc, setDoc, deleteDoc, onSnapshot, query, orderBy },
      st: { ref, uploadBytes, getDownloadURL, deleteObject }
    };

    onAuthStateChanged(auth, u => console.log("Firebase signed in as:", u?.uid || null));
  </script>

  <script src="/app.js"></script>
  <script>

      // ===== Minimal Cloud Sync (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏î‡πÇ‡∏°‡πà) =====
      (function cloudSync(){
        if (!window._fb) return;
        const { db, storage, fs, st } = window._fb;
        const colMoments = fs.collection(db, "moments");
        const colPhotos  = fs.collection(db, "photos");
        const colEvents  = fs.collection(db, "events");
        const docNotes   = (id="shared") => fs.doc(db, "notes", id);

        const oldAddMoment = document.querySelector('#btn-add-moment')?.onclick;
        document.querySelector('#btn-add-moment').onclick = async (e) => {
          await oldAddMoment?.(e);
          const last = window.DB?.moments?.at(-1);
          if (!last) return;
          try {
            await fs.addDoc(colMoments, { text:last.text, date:last.date, tags:last.tags||[], createdAt: fs.serverTimestamp() });
            console.log('synced moment');
          } catch(err){ console.warn(err); }
        };

        const oldUpload = document.querySelector('#btn-upload')?.onclick;
        document.querySelector('#btn-upload').onclick = async (e) => {
          await oldUpload?.(e);
          const last = window.DB?.gallery?.[0];
          if (!last) return;
          try{
            const b64 = last.dataURL.split(',')[1];
            const bin = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
            const key = `uploads/${Date.now()}-${last.id}.jpg`;
            const r = st.ref(storage, key);
            await st.uploadBytes(r, bin, { contentType: 'image/jpeg' });
            const url = await st.getDownloadURL(r);
            await fs.addDoc(colPhotos, { url, storagePath:key, createdAt: fs.serverTimestamp() });
            console.log('synced photo');
          }catch(err){ console.warn(err); }
        };

        const oldAddEv = document.querySelector('#btn-add-ev')?.onclick;
        document.querySelector('#btn-add-ev').onclick = async (e) => {
          await oldAddEv?.(e);
          const last = window.DB?.events?.at(-1);
          if (!last) return;
          try{
            await fs.addDoc(colEvents, { title:last.title, atISO:last.atISO, createdAt: fs.serverTimestamp() });
            console.log('synced event');
          }catch(err){ console.warn(err); }
        };

        const oldSave = document.querySelector('#btn-save-note')?.onclick;
        document.querySelector('#btn-save-note').onclick = async (e) => {
          await oldSave?.(e);
          try{
            await fs.setDoc(docNotes(), { text: window.DB?.note || '', updatedAt: fs.serverTimestamp() }, { merge:true });
            console.log('synced note');
          }catch(err){ console.warn(err); }
        };

        window.addEventListener('DOMContentLoaded', () => {
          fs.onSnapshot(docNotes(), (snap) => {
            const data = snap.data();
            if (data?.text && data.text !== window.DB?.note) {
              window.DB.note = data.text;
              window.renderNote?.();
            }
          });
        });
      })();

  </script>
</body>
</html>
